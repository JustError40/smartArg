# Техническое задание на проект  
## «Система интеллектуального анализа и суммаризации сообщений из Telegram-чатов для формирования базы знаний»

---

## 1. Цель проекта

Целью проекта является разработка серверного веб-сервиса с Telegram-ботом, который автоматически собирает сообщения из Telegram-чатов, анализирует их с помощью AI-агентов, извлекает значимую учебную информацию (объявления, дедлайны, ссылки) и сохраняет структурированные результаты в централизованной базе знаний.

Проект предназначен для решения проблемы информационного шума в учебных Telegram-чатах, где важные сообщения преподавателей и администрации теряются среди большого объёма нерелевантного общения.

---

## 2. Целевая аудитория и роли пользователей

### Целевая аудитория
- студенты, состоящие в учебных Telegram-чатах;
- участники учебных групп и курсов.

### Роли пользователей

- **Пользователь (владелец системы)**  
  Управляет системой, подключёнными чатами, просматривает базу знаний, аналитику и результаты AI-анализа.

- **Telegram-бот**  
  Источник данных. Подключается к чатам, принимает сообщения и передаёт их в backend для последующей обработки.

- **Backend-сервис**  
  Выполняет хранение данных, AI-анализ, агрегацию, аналитику и визуализацию информации.

---

## 3. Архитектура проекта

Проект реализуется в виде распределённой системы с разделением ответственности между компонентами.

### Основные компоненты

- **Django Web Backend**  
  Хранение данных, управление моделями, AI-анализ, аналитика и web-интерфейс.

- **Telegram Bot (Aiogram)**  
  Получение сообщений из Telegram-чатов и передача их в backend.

- **AI-подсистема анализа**  
  Отдельный сервисный слой, использующий LLM для обработки контента.

- **Асинхронная обработка**  
  Используется Celery с Redis для выполнения AI-анализа в фоне.

---

## 4. Технологический стек

- Backend: Python, Django  
- База данных: PostgreSQL  
- Асинхронные задачи: Celery + Redis  
- Telegram Bot: Aiogram  
- AI / LLM: OpenAI / Z.AI / Ollama (выбор через переменные окружения)  
- Контейнеризация: Docker, Docker Compose  
- Аналитика: Pandas, Matplotlib  
- Валидация данных: Pydantic  
- Интерфейс: Django Templates + Bootstrap (русскоязычный UI)

---

## 5. Контейнеризация и окружение

Проект разворачивается с использованием Docker и Docker Compose.

### Контейнеры
- `web` — Django backend  
- `db` — PostgreSQL  
- `redis` — брокер сообщений  
- `worker` — Celery worker  
- `bot` — Telegram-бот (Aiogram)

Все конфигурационные параметры (ключи API, настройки БД, выбор LLM-провайдера) передаются через переменные окружения.

---

## 6. Схема данных (модели)

### Chat — Telegram-чат
- `id`
- `title`
- `type`

### Message — сообщение из чата
- `chat` (ForeignKey → Chat)
- `sender`
- `role` (teacher / student / unknown)
- `text`
- `date`

### AnalysisResult — результат AI-анализа
- `message` (ForeignKey → Message)
- `category` (announcement / deadline / link / other)
- `summary`
- `created_at`

### KnowledgeEntry — запись в базе знаний
- `source_message` (ForeignKey → Message)
- `entry_type` (deadline / info / link)
- `content`
- `created_at`

Все модели логически связаны и используются в основных сценариях проекта.

---

## 7. Унифицированная схема входных данных (Ingestion Layer)

Для декомпозиции источников данных используется унифицированная схема входного контента.

### Pydantic-схема `IngestionData`
- `text` — исходный текст
- `source_type` — тип источника (`telegram`, `web_schedule`)
- `metadata` — дополнительные данные (словарь)

Данная схема позволяет:
- обрабатывать данные из разных источников одинаковым образом;
- масштабировать систему за пределы Telegram.

---

## 8. AI-подсистема анализа

AI-анализ реализуется в модуле `analysis/ai_engine.py`.

### Основные компоненты
- `AIService` — сервис работы с LLM (через LangChain)
- `PromptFactory` — фабрика промптов, выбирающая шаблон в зависимости от `source_type`

### Поддерживаемые типы анализа
- `telegram` — извлечение дедлайнов, объявлений, ссылок, суммаризация
- `web_schedule` — заглушка для анализа расписаний (в текущей версии)

Выбор AI-провайдера осуществляется через переменные окружения без изменения бизнес-логики.

---

## 9. Асинхронная обработка данных

AI-анализ выполняется асинхронно с использованием Celery.

### Задача `process_content_task`
1. Десериализация входных данных `IngestionData`
2. Вызов AI-сервиса
3. Сохранение результатов в `AnalysisResult`
4. Формирование записей в `KnowledgeEntry`

Асинхронная обработка обеспечивает неблокирующую работу Telegram-бота и масштабируемость системы.

---

## 10. Telegram-бот

Telegram-бот реализован с использованием Aiogram.

### Основной сценарий работы
1. Получение сообщения из чата
2. Сохранение raw-сообщения в таблицу `Message`
3. Формирование объекта `IngestionData`
4. Отправка данных в Celery-задачу на обработку

Бот не содержит бизнес-логики анализа.

Запуск бота осуществляется через management-command:

```bash
python manage.py runbot
